<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Navigation</title>
    <link rel="stylesheet" href="driver_search.css">
    <link rel="stylesheet" href="../public/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

</head>

<body>
    <script src="../javaScript/check_token.js"></script>
    <!-- header-->
    <section id="header">
        <a href="#"><img src="../images/fast-delivery1.png" class="logo"></a>
        <div>
            <ul id="navbar">
                <li><a href="driver_home.html">Trang chủ</a></li>
                <li><a class="active" href="driver_search.html">Tìm kiếm</a></li>
                <li><a href="driver_chat.html">Tư vấn</a></li>
                <li><a href="driver_infor.html">Thông tin</a></li>
                <li><a id="user-info"><button id="logoutButton">Đăng xuất</button></a></li>
            </ul>
        </div>
    </section>

    <!-- Your page content goes here -->
    <div align="center" class="container">
        <div class="background">
            <form method="post">
                <div class="title_search">
                    <h1 style="color: black;">Tìm kiếm đơn hàng</h1>
                </div>
                <br><br><br>
                <table class="create1">
                    <tr>
                        <td>Địa điểm đi: </td>
                        <td>
                            <select id="city" class="select1">
                                <option value="" selected>Chọn tỉnh thành</option>
                            </select>
                        </td>
                        <td>
                            <select id="district" class="select1">
                                <option value="" selected>Chọn quận huyện</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Địa điểm đến: </td>
                        <td>
                            <select id="cityCome" class="select1">
                                <option value="" selected>Chọn tỉnh thành</option>
                            </select>
                        </td>
                        <td>
                            <select id="districtCome" class="select1">
                                <option value="" selected>Chọn quận huyện</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Chọn xe: </td>
                        <td>
                            <select id="dynamicSelect" class="select1">
                                <option value="" selected>Chọn xe</option>
                            </select>

                        </td>
                    </tr>
                </table>
                <br><br><br>
                <input type="button" value="Tìm kiếm" onclick="submitAndDisplay()" style="margin-top: 5px"
                    class="button1" />
            </form>
        </div>
    </div>
    <div style="display: flex; flex-wrap: wrap;width:auto; gap: 50px; background-color: floralwhite;padding: 10px;"
        id="resultContainer"></div>
    </div>



    <div align="center" style=" display: flex; justify-content: center;">
        <button id="Previous" onclick="goPrevious()" style="margin: auto; display: none;">TRANG TRƯỚC</button>
        <button id="Next" onclick="goNext()" style="margin: auto; display: none;">TRANG SAU</button>
    </div>



    <footer class="section-p1">
        <div class="col">
            <img class="logo" src="../images/fast-delivery1.png" alt="">
            <h4>Contact</h4>
            <p><strong>Address:</strong> 562 Trần đại nghĩa, Hai Bà Trưng, Hà Nội</p>
            <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
            <div class="follow">
                <h4>Follow us</h4>
                <div class="icon">
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-pinterest-p"></i>
                    <i class="fab fa-youtube"></i>

                </div>
            </div>
        </div>

        <div class="col">
            <h4>About</h4>
            <a href="#">About us</a>
            <a href="#">Delivery Information</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Term & Conditions</a>
            <a href="#">Contact Us</a>
        </div>

        <div class="col">
            <h4>My Account</h4>
            <a href="#">Sign In</a>
            <a href="#">View Cart</a>
            <a href="#">My Wishlist</a>
            <a href="#">Track My Order</a>
            <a href="#">Help</a>
        </div>

        <div class="col install">
            <h4>Install App</h4>
            <p>From App Store or Google Play</p>
            <div class="row">
                <img src="../public/images/pay/app.jpg" alt="">
                <img src="../public/images/pay/play.jpg" alt="">
            </div>
            <p>Secured Payment Gateways</p>
            <img src="../public/images/pay/pay.png" alt="">
        </div>

        <div class="copyright">
            <p>@ 2023, Tech etc - HTML CSS Ecomerce Template</p>
        </div>
    </footer>



    <script>

        //let intervalId;

        let pageSize = 6;
        let currentPagenumberItem = 1;
        let originalArray = [];
        let currentPage = 1;
        let displayArray = [];
        const itemsPerPage = 10;
        const tableDOM = document.querySelector('.resultContainer');

        const pagination = (currentPage, numberItem) => {
            let pri = document.getElementById("Previous");
            let next = document.getElementById("Next");
            pri.style.display = "block";
            next.style.display = "block";
            if (currentPage == 1) pri.style.display = "none";

            const startIndex = (currentPage - 1) * numberItem;
            currentPagenumberItem = startIndex + 1;
            displayArray = originalArray.slice(startIndex, startIndex + numberItem);

            if ((originalArray.slice(currentPage * numberItem, currentPage * numberItem + numberItem)).length === 0) next.style.display = "none";
            displayResults(displayArray);
        }

        const goPrevious = () => {
            currentPage--;
            if (currentPage < 0) {
                currentPage == 0;
            }
            else
                pagination(currentPage, pageSize);
        }
        const goNext = () => {
            currentPage++;
            pagination(currentPage, pageSize);
        }





        function submitAndDisplay() {
            // Lấy giá trị từ trường select
            var selectedOviId = document.getElementById("dynamicSelect").value;
            var selectedProGo = document.getElementById("city").value;
            var selectedDisGo = document.getElementById("district").value;
            var selectedProCome = document.getElementById("cityCome").value;
            var selectedDisCome = document.getElementById("districtCome").value;

            // Kiểm tra xem interval cũ có tồn tại hay không

            // if (intervalId) {
            //     clearInterval(intervalId); // Clear interval cũ nếu tồn tại
            // }

            // Tạo mới interval
            //intervalId = setInterval(function () {
            fetch("https://localhost:7156/api/Driver/FilteredOrdersList", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oviId: selectedOviId,
                    disGo: selectedDisGo,
                    proGo: selectedProGo,
                    disCome: selectedDisCome,
                    proCome: selectedProCome,
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);

                    originalArray = data;
                    pagination(1, pageSize);



                    // Hiển thị kết quả trong div lớn
                    //displayResults(data);
                })
                .catch(error => {
                    console.error("Error:", error);
                    // Xử lý lỗi nếu cần
                });
            //}, 1000);
        }


        // Hàm để hiển thị kết quả trong div lớn
        function displayResults(results) {
            // Lấy phần tử div lớn để chứa các div con
            var resultContainer = document.getElementById("resultContainer");

            // Xóa nội dung cũ của div lớn
            resultContainer.innerHTML = "";

            // Thêm dữ liệu mới từ kết quả API vào div lớn
            results.forEach(result => {
                var resultDiv = document.createElement("div");
                resultDiv.classList.add("result-item");

                // Thêm nội dung của mỗi item vào div con
                var oVVId = document.getElementById("dynamicSelect").value;
                resultDiv.innerHTML = `
                <div class="result-content">
                    <div class="result-heading">
                        <h3 >${result.order.orderName}</h3>
                    </div>
                    <div class="result-body">
                        <p class="result-text"><strong class="t">Ngày đi:</strong> ${result.order.orderedDate}</p>
                        <p class="result-text"><strong class="t">Ngày đến:</strong> ${result.order.arrivedDate}</p>
                        <p class="result-text"><strong class="t">Điểm đi:</strong> ${result.order.wardGo} - ${result.order.detailPositionGo}</p>
                        <p class="result-text"><strong class="t">Điểm đến:</strong> ${result.order.wardCome} - ${result.order.detailPositionCome}</p>
                        <p class="result-text"><strong class="t">Tiền công:</strong> ${result.order.totalAmount} USD</p>
                    </div>
                </div>
            `;
                if (result.checkWAL == true) {
                    var XemChiTiet = document.createElement("div");
                    XemChiTiet.innerHTML = `<a target="_blank" href='detail_order.html?orderId=${result.order.orderId}&oVIId=${oVVId}' ><button style="background-color: rgba(29, 161, 242, 1);cursor: pointer;border: none;padding: 13px 13px;border-radius: 22px;color: white;font-size: 17px;font-weight: 500;">Xem chi tiết<font color="red" style="font-weight:700">|Đã ứng tuyển</font></button></a>`;
                    resultDiv.appendChild(XemChiTiet);
                }
                else {
                    var XemChiTiet = document.createElement("div");
                    XemChiTiet.innerHTML = `<a target="_blank" href='detail_order.html?orderId=${result.order.orderId}&oVIId=${oVVId}' ><button style="background-color: rgba(29, 161, 242, 1);cursor: pointer;border: none;padding: 13px 13px;border-radius: 22px;color: white;font-size: 17px;font-weight: 500;">Xem chi tiết</button></a>`;
                    resultDiv.appendChild(XemChiTiet);
                }

                resultDiv.style.boxShadow = "5px 5px 10px rgba(0, 0, 0, 0.4)";
                resultDiv.style.paddingBottom = "15px";
                resultDiv.align = "center";
                resultDiv.style.borderRadius = "7px"
                // Thêm thuộc tính data-attribute với giá trị là oviId
                resultDiv.setAttribute("data-oviId", result.oviId);
                // Thêm div con vào div lớn
                resultContainer.appendChild(resultDiv);
            });
        }

        // Gọi hàm để tải tùy chọn khi trang được tải
        document.addEventListener("DOMContentLoaded", function () {
            populateSelect();
        });
    </script>















    <script>
        // Hàm để gọi API và cập nhật trường select
        function populateSelect() {
            // Thực hiện yêu cầu GET đến API để lấy danh sách tùy chọn
            fetch("https://localhost:7156/api/Driver/GetVehicleList?driverId=" + JSON.parse(localStorage.getItem('userInfo')).id)
                .then(response => response.json())
                .then(data => {
                    // Lấy phần tử select
                    var selectElement = document.getElementById("dynamicSelect");

                    // Xóa các tùy chọn hiện tại
                    selectElement.innerHTML = "";

                    // Thêm tùy chọn mới từ dữ liệu nhận được từ API
                    data.forEach(vehicle => {
                        var optionElement = document.createElement("option");
                        optionElement.value = vehicle.oviId;
                        optionElement.textContent = vehicle.description;
                        selectElement.appendChild(optionElement);
                    });
                })
                .catch(error => {
                    console.error("Error:", error);
                    // Xử lý lỗi nếu cần
                });
        }

        // Gọi hàm để tải tùy chọn khi trang được tải
        document.addEventListener("DOMContentLoaded", function () {
            populateSelect();
        });
    </script>






    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        const host = "https://provinces.open-api.vn/api/";

        var callAPI = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data, "city");
                });
        }

        var callAPICome = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data, "cityCome");
                });
        }

        callAPI('https://provinces.open-api.vn/api/?depth=1');

        callAPICome('https://provinces.open-api.vn/api/?depth=1');

        var callApiDistrict = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.districts, "district");
                });
        }

        var callApiDistrictCome = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.districts, "districtCome");
                });
        }

        var renderData = (array, select) => {
            let row = ' <option disable value="">Chọn</option>';
            array.forEach(element => {
                row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
            });
            document.querySelector("#" + select).innerHTML = row
        }

        var renderDataCome = (array, select) => {
            let row = ' <option disable value="">Chọn</option>';
            array.forEach(element => {
                row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
            });
            document.querySelector("#" + select).innerHTML = row
        }

        $("#city").change(() => {
            callApiDistrict(host + "p/" + $("#city").find(':selected').data('id') + "?depth=2");
        });

        $("#cityCome").change(() => {
            callApiDistrictCome(host + "p/" + $("#cityCome").find(':selected').data('id') + "?depth=2");
        });

        $("#district").change(() => {
        })

        $("#districtCome").change(() => {
        })
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var storedUserInformation = localStorage.getItem('userInfo');
            var parsedUserInformation = JSON.parse(storedUserInformation);
            var id = parsedUserInformation.id;
            var userInfoContainer = document.getElementById('user-info');

            if (parsedUserInformation) {
                var username = parsedUserInformation.username; // Giả sử tên người dùng được lưu trong userInfo

                var userInfoElement = document.createElement('a');
                userInfoElement.href = '../public/view_driver_infor.html?driverId=' + id;
                userInfoElement.target = 'blank';
                userInfoElement.textContent = 'Chào, ' + username; // Thông tin về người dùng

                userInfoContainer.appendChild(userInfoElement);


                logoutButton.addEventListener('click', function () {
                    // Xóa thông tin người dùng từ localStorage và chuyển hướng về trang đăng nhập
                    localStorage.removeItem('userInfo');
                    window.location.href = "../public/login.html";
                });

                userInfoContainer.appendChild(logoutButton);
            } else {
                // Chuyển hướng về trang đăng nhập nếu thông tin người dùng không được tìm thấy
                window.location.href = "../public/login.html";
            }
        });
    </script>


</body>

</html>