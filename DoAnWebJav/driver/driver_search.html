<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Navigation</title>
    <link rel="stylesheet" href="driver_search.css">
    <style>
        /* CSS cho nút đăng xuất */
        #logoutButton {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button#logoutButton {
            margin-left: 10px;
        }

        /* Hover effect */
        #logoutButton:hover {
            background-color: #d32f2f;
        }
    </style>
</head>

<body>
    <script src="../javaScript/check_token.js"></script>
    <!-- header-->
    <section id="header">
        <a href="#"><img src="../images/fast-delivery1.png" class="logo"></a>
        <div>
            <ul id="navbar">
                <li><a href="driver_home.html">Trang chủ</a></li>
                <li><a class="active" href="driver_search.html">Tìm kiếm</a></li>
                <li><a href="driver_chat.html">Tư vấn</a></li>
                <li><a href="driver_infor.html">Thông tin</a></li>
                <li><a id="user-info"><button id="logoutButton">Đăng xuất</button></a></li>
            </ul>
        </div>
    </section>

    <!-- Your page content goes here -->
    <div align="center" class="container">
        <div class="background">



            <form method="post">
                <h1 style="color: black;">Tìm kiếm đơn hàng</h1>
                <br><br><br>
                <table class="create1">
                    <tr>
                        <td>Địa điểm đi : </td>
                        <td>
                            <select id="city" class="select1">
                                <option value="" selected>Chọn tỉnh thành</option>
                            </select>
                        </td>
                        <td>
                            <select id="district" class="select1">
                                <option value="" selected>Chọn quận huyện</option>
                            </select>
                        </td>

                    </tr>
                    <tr>

                        <td>Địa điểm đến : </td>
                        <td>
                            <select id="cityCome" class="select1">
                                <option value="" selected>Chọn tỉnh thành</option>
                            </select>
                        </td>
                        <td>
                            <select id="districtCome" class="select1">
                                <option value="" selected>Chọn quận huyện</option>
                            </select>
                        </td>

                    </tr>
                    <tr>

                        <td>Chọn xe : </td>
                        <td>
                            <select id="dynamicSelect" class="select1">
                                <option value="" selected>Chọn xe</option>
                            </select>

                        </td>


                    </tr>
                </table>
                <br><br><br>
                <input type="button" value="tìm kiếm" onclick="submitAndDisplay()" style="margin-top: 5px"
                    class="button1" />
            </form>



        </div>

    </div>
    <div style="margin-top: 20px;display: flex; flex-wrap: wrap;width:auto; gap: 50px" id="resultContainer"></div>
    </div>







    <script>
        // Hàm để gọi API, gửi dữ liệu và hiển thị kết quả
        let intervalId;

        function submitAndDisplay() {
            // Lấy giá trị từ trường select
            var selectedOviId = document.getElementById("dynamicSelect").value;
            var selectedProGo = document.getElementById("city").value;
            var selectedDisGo = document.getElementById("district").value;
            var selectedProCome = document.getElementById("cityCome").value;
            var selectedDisCome = document.getElementById("districtCome").value;

            // Kiểm tra xem interval cũ có tồn tại hay không
            if (intervalId) {
                clearInterval(intervalId); // Clear interval cũ nếu tồn tại
            }

            // Tạo mới interval
            intervalId = setInterval(function () {
                fetch("https://localhost:7156/api/Driver/FilteredOrdersList", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oviId: selectedOviId,
                        disGo: selectedDisGo,
                        proGo: selectedProGo,
                        disCome: selectedDisCome,
                        proCome: selectedProCome,
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data);
                        // Hiển thị kết quả trong div lớn
                        displayResults(data);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        // Xử lý lỗi nếu cần
                    });
            }, 1000);
        }

        // Hàm để hiển thị kết quả trong div lớn
        function displayResults(results) {
            // Lấy phần tử div lớn để chứa các div con
            var resultContainer = document.getElementById("resultContainer");

            // Xóa nội dung cũ của div lớn
            resultContainer.innerHTML = "";

            // Thêm dữ liệu mới từ kết quả API vào div lớn
            results.forEach(result => {
                var resultDiv = document.createElement("div");
                resultDiv.classList.add("result-item");

                // Thêm nội dung của mỗi item vào div con
                var oVVId = document.getElementById("dynamicSelect").value;
                resultDiv.innerHTML = `
                <h3 align="center" style="color:white; background-color:gray">${result.order.orderName}</h3>
                <p><strong>Ngày đi:</strong> ${result.order.orderedDate}</p>
                <p><strong>Ngày đến:</strong> ${result.order.arrivedDate}</p>
                <p><strong>Điểm đi:</strong> ${result.order.wardGo} - ${result.order.detailPositionGo}</p>
                <p><strong>Điểm đến:</strong> ${result.order.wardCome} - ${result.order.detailPositionCome}</p>
                <p><strong>Tiền công:</strong> ${result.order.totalAmount} USD</p>
            `;
                if (result.checkWAL == true) {
                    var XemChiTiet = document.createElement("div");
                    XemChiTiet.innerHTML = `<a target="_blank" href='detail_order.html?orderId=${result.order.orderId}&oVIId=${oVVId}' ><button>Xem chi tiết<font color="red"> *Đã ứng tuyển</font></button></a>`;
                    resultDiv.appendChild(XemChiTiet);
                }
                else {
                    var XemChiTiet = document.createElement("div");
                    XemChiTiet.innerHTML = `<a target="_blank" href='detail_order.html?orderId=${result.order.orderId}&oVIId=${oVVId}' ><button>Xem chi tiết</button></a>`;
                    resultDiv.appendChild(XemChiTiet);
                }

                //resultDiv.style.backgroundColor = "gray";
                resultDiv.style.boxShadow = "5px 5px 10px rgba(0, 0, 0, 0.4)";
                resultDiv.style.paddingLeft = "10px";
                resultDiv.style.paddingRight = "10px";
                resultDiv.style.paddingBottom = "15px";
                resultDiv.align = "center";
                // Thêm thuộc tính data-attribute với giá trị là oviId
                resultDiv.setAttribute("data-oviId", result.oviId);
                // Thêm div con vào div lớn
                resultContainer.appendChild(resultDiv);
            });
        }

        // Gọi hàm để tải tùy chọn khi trang được tải
        document.addEventListener("DOMContentLoaded", function () {
            populateSelect();
        });
    </script>















    <script>
        // Hàm để gọi API và cập nhật trường select
        function populateSelect() {
            // Thực hiện yêu cầu GET đến API để lấy danh sách tùy chọn
            fetch("https://localhost:7156/api/Driver/GetVehicleList?driverId=" + JSON.parse(localStorage.getItem('userInfo')).id)
                .then(response => response.json())
                .then(data => {
                    // Lấy phần tử select
                    var selectElement = document.getElementById("dynamicSelect");

                    // Xóa các tùy chọn hiện tại
                    selectElement.innerHTML = "";

                    // Thêm tùy chọn mới từ dữ liệu nhận được từ API
                    data.forEach(vehicle => {
                        var optionElement = document.createElement("option");
                        optionElement.value = vehicle.oviId;
                        optionElement.textContent = vehicle.description;
                        selectElement.appendChild(optionElement);
                    });
                })
                .catch(error => {
                    console.error("Error:", error);
                    // Xử lý lỗi nếu cần
                });
        }

        // Gọi hàm để tải tùy chọn khi trang được tải
        document.addEventListener("DOMContentLoaded", function () {
            populateSelect();
        });
    </script>






    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        const host = "https://provinces.open-api.vn/api/";

        var callAPI = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data, "city");
                });
        }

        var callAPICome = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data, "cityCome");
                });
        }

        callAPI('https://provinces.open-api.vn/api/?depth=1');

        callAPICome('https://provinces.open-api.vn/api/?depth=1');

        var callApiDistrict = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.districts, "district");
                });
        }

        var callApiDistrictCome = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.districts, "districtCome");
                });
        }

        var renderData = (array, select) => {
            let row = ' <option disable value="">Chọn</option>';
            array.forEach(element => {
                row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
            });
            document.querySelector("#" + select).innerHTML = row
        }

        var renderDataCome = (array, select) => {
            let row = ' <option disable value="">Chọn</option>';
            array.forEach(element => {
                row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
            });
            document.querySelector("#" + select).innerHTML = row
        }

        $("#city").change(() => {
            callApiDistrict(host + "p/" + $("#city").find(':selected').data('id') + "?depth=2");
        });

        $("#cityCome").change(() => {
            callApiDistrictCome(host + "p/" + $("#cityCome").find(':selected').data('id') + "?depth=2");
        });

        $("#district").change(() => {
        })

        $("#districtCome").change(() => {
        })
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var storedUserInformation = localStorage.getItem('userInfo');
            var parsedUserInformation = JSON.parse(storedUserInformation);
            var id = parsedUserInformation.id;
            var userInfoContainer = document.getElementById('user-info');

            if (parsedUserInformation) {
                var username = parsedUserInformation.username; // Giả sử tên người dùng được lưu trong userInfo

                var userInfoElement = document.createElement('a');
                userInfoElement.href = '../public/view_driver_infor.html?driverId=' + id;
                userInfoElement.target = 'blank';
                userInfoElement.textContent = 'Chào, ' + username; // Thông tin về người dùng

                userInfoContainer.appendChild(userInfoElement);


                logoutButton.addEventListener('click', function () {
                    // Xóa thông tin người dùng từ localStorage và chuyển hướng về trang đăng nhập
                    localStorage.removeItem('userInfo');
                    window.location.href = "../public/login.html";
                });

                userInfoContainer.appendChild(logoutButton);
            } else {
                // Chuyển hướng về trang đăng nhập nếu thông tin người dùng không được tìm thấy
                window.location.href = "../public/login.html";
            }
        });
    </script>


</body>

</html>